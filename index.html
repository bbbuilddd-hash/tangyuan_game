<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="format-detection" content="telephone=no">
  <title>ä¸€ç¬”åƒæ±¤åœ†</title>
  <style>
    :root {
      --bg-color: #ffccbc;
      --primary-color: #ff7043;
      --text-color: #5d4037;
      --grid-gap: 12px;
      --cell-size: 50px;
    }
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; min-height: 100%; background: var(--bg-color); }
    body {
      font-family: "Microsoft YaHei", "PingFang SC", "Heiti SC", sans-serif;
      background-image: radial-gradient(circle at 50% 0%, #ffab91 0%, #ffccbc 70%);
      color: var(--text-color);
      min-height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .page {
      width: 100%;
      min-height: 100dvh;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: max(16px, env(safe-area-inset-top)) 16px max(16px, env(safe-area-inset-bottom));
    }
    .page.active { display: flex; }
    .game-title {
      font-size: 2.1rem; color: #d84315; text-shadow: 2px 2px 0 #fff; margin: 0 0 10px;
      font-weight: 900; text-align: center; letter-spacing: 2px;
    }
    .big-emoji { font-size: 4rem; margin-bottom: 10px; }
    .btn {
      background: #fff; border: 3px solid #ff7043; border-radius: 50px; padding: 12px 34px;
      font-size: 1.15rem; color: #d84315; font-weight: bold; margin: 10px; cursor: pointer;
      box-shadow: 0 4px 0 #ffab91; transition: transform .08s, box-shadow .08s;
      width: 80%; max-width: 280px; text-align: center;
    }
    .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #ffab91; }
    .subtext { color:#d84315; margin-bottom: 24px; font-size: 1.04rem; text-align:center; }
    .game-header {
      width: 100%; max-width: 460px; display:flex; justify-content:space-between; gap:10px;
      padding: 10px 16px; font-size:1.05rem; font-weight:bold; color:#d84315;
      background: rgba(255,255,255,.65); border-radius:20px; margin-bottom:12px;
      box-shadow: 0 2px 5px rgba(0,0,0,.05);
    }
    .game-tip, .small-box {
      background: rgba(255,255,255,.7); color:#d84315; border-radius:14px; text-align:center;
      font-weight:bold;
    }
    .game-tip { font-size: .98rem; padding: 8px 18px; margin-bottom: 10px; }
    .small-box { margin-bottom: 10px; font-size: .9rem; padding: 6px 14px; }
    .grid-container {
      display:grid; gap:var(--grid-gap); background:rgba(255,255,255,.55); padding:14px; border-radius:20px;
      touch-action:none; box-shadow:0 10px 20px rgba(216,67,21,.15); position:relative;
      max-width: 92vw; overflow:hidden;
    }
    .cell {
      width:var(--cell-size); height:var(--cell-size); border-radius:50%; display:flex; align-items:center;
      justify-content:center; position:relative; transition:transform .12s, background-color .12s, opacity .12s;
      background:#fff; box-shadow:0 4px 6px rgba(0,0,0,.1);
    }
    .cell.tangyuan::before {
      content:''; position:absolute; width:85%; height:85%; background:#fff; border-radius:50%; z-index:1;
      box-shadow: inset -2px -2px 5px rgba(0,0,0,.05);
    }
    .cell.tangyuan::after {
      content:''; position:absolute; width:5px; height:5px; background:#333; border-radius:50%; top:38%; left:35%;
      box-shadow:12px 0 0 #333; z-index:2;
    }
    .cell.tangyuan .mouth {
      position:absolute; width:6px; height:3px; border-bottom:2px solid #ff5252; border-radius:50%; top:55%; left:50%;
      transform:translateX(-50%); z-index:2;
    }
    .cell.tangyuan .blush {
      position:absolute; width:8px; height:5px; background:#ffab91; border-radius:50%; top:52%; opacity:.7; z-index:1;
    }
    .cell.tangyuan .blush.left { left:22%; }
    .cell.tangyuan .blush.right { right:22%; }
    .cell.egg { background:transparent; box-shadow:none; border:none; }
    .cell.egg::before {
      content:''; position:absolute; width:90%; height:90%; background:#fff; border-radius:45% 55% 50% 50% / 55% 45% 50% 50%;
      box-shadow:0 2px 4px rgba(0,0,0,.1); z-index:1; transform:rotate(15deg);
    }
    .cell.egg::after {
      content:''; position:absolute; width:40%; height:40%; background:#ffca28; border-radius:50%; top:30%; left:30%;
      z-index:2; box-shadow: inset 2px 2px 4px rgba(0,0,0,.1); transform:rotate(-15deg);
    }
    .cell.path { background:#ffcc80; transform:scale(1.15); z-index:10; box-shadow:0 0 10px rgba(255,160,0,.6); }
    .cell.eaten { background:#fff9c4; opacity:.6; transform:scale(.9); }
    .cell.eaten::after, .cell.eaten .mouth, .cell.eaten .blush { display:none; }
    .cell.eaten::before { background:#fff9c4; }
    .modal {
      position:fixed; inset:0; background:rgba(255,255,255,.94); display:none; flex-direction:column; align-items:center;
      justify-content:center; z-index:100; text-align:center; padding: 20px;
    }
    .rank-list {
      width: min(92vw, 420px); max-height: 58dvh; overflow:auto; background:rgba(255,255,255,.72); border-radius:20px;
      padding: 12px; box-shadow:0 10px 20px rgba(0,0,0,.08);
    }
    .rank-item {
      display:flex; justify-content:space-between; gap:12px; align-items:center; padding:10px 12px;
      background:#fff; border-radius:14px; margin-bottom:10px; color:#5d4037; font-weight:bold;
      font-size:.96rem;
    }
    .hint {
      width:min(92vw,420px); background:rgba(255,255,255,.7); color:#8d6e63; border-radius:14px; padding:10px 12px;
      margin-bottom:12px; font-size:.92rem; text-align:center;
    }
    #name-modal input {
      width:min(80vw,280px); padding:12px 20px; border:3px solid #ff7043; border-radius:50px; font-size:1.1rem;
      color:#5d4037; margin:20px 0; text-align:center; outline:none;
    }
    #name-modal input::placeholder { color:#ffab91; }
    #fatal-box {
      display:none; position:fixed; left:10px; right:10px; bottom:10px; background:#fff3e0; color:#bf360c;
      border:2px solid #ffab91; border-radius:14px; padding:10px 12px; z-index:999; font-size:.9rem;
    }
  </style>
</head>
<body>
  <div id="home-page" class="page active">
    <div class="big-emoji">ğŸ¡</div>
    <h1 class="game-title">ä¸€ç¬”åƒæ±¤åœ†</h1>
    <p class="subtext">é¿å¼€ç…è›‹ ğŸ³ï¼Œè¿å®Œæ‰€æœ‰æ±¤åœ†ï¼</p>
    <div class="btn" id="btn-start">å¼€å§‹æŒ‘æˆ˜</div>
    <div class="btn" id="btn-rank" style="background:#ffccbc;border-color:#d84315;">æ’è¡Œæ¦œ</div>
  </div>

  <div id="game-page" class="page">
    <div class="game-header">
      <span id="level-info">ç¬¬ 1/5 å…³</span>
      <span id="timer">0.00s</span>
    </div>
    <div class="game-tip">é¿å¼€ç…è›‹ï¼Œä¸€ç¬”è¿æ¥æ‰€æœ‰æ±¤åœ†</div>
    <div class="small-box">å‰©ä½™æ±¤åœ†ï¼š<span id="remaining" style="font-weight:bold;font-size:1.08rem;">0</span></div>
    <div id="grid" class="grid-container"></div>
  </div>

  <div id="modal-win" class="modal">
    <div class="big-emoji">ğŸ˜‹</div>
    <h2>å¤ªå¥½åƒå•¦ï¼</h2>
    <p id="win-msg">æœ¬å…³ç”¨æ—¶ 3.50s</p>
    <div class="btn" id="btn-next">ä¸‹ä¸€å…³</div>
  </div>

  <div id="modal-final" class="modal">
    <div class="big-emoji">ğŸ†</div>
    <h2>æŒ‘æˆ˜æˆåŠŸï¼</h2>
    <p>æ€»ç”¨æ—¶ï¼š<span id="final-time" style="color:#d84315;font-weight:bold;font-size:1.4rem;">0s</span></p>
    <div class="btn" id="btn-submit">ä¿å­˜æˆç»©</div>
    <div class="hint">è¿™ä¸ªç‰ˆæœ¬ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨è„šæœ¬æˆ–æ•°æ®åº“ã€‚æ’è¡Œæ¦œä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼Œé¡µé¢æ›´ç¨³ã€‚</div>
  </div>

  <div id="name-modal" class="modal">
    <div class="big-emoji">âœï¸</div>
    <h2>è¯·è¾“å…¥æ‚¨çš„å§“å</h2>
    <input type="text" id="player-name" placeholder="æ¯”å¦‚ï¼šåƒè´§å°æ±¤åœ†" maxlength="10" autocomplete="nickname" autocapitalize="off" spellcheck="false">
    <div class="btn" id="btn-confirm-name">ç¡®è®¤å¼€å§‹</div>
  </div>

  <div id="rank-page" class="page">
    <h2 class="game-title">ğŸ… åƒè´§æ’è¡Œæ¦œ</h2>
    <div class="hint">å½“å‰ä¸ºæœ¬æœºæ’è¡Œæ¦œï¼šä¸èµ°å¤–éƒ¨ CDNï¼Œä¸è¿äº‘æ•°æ®åº“ï¼Œå°½é‡é™ä½ iPhone / å¼±ç½‘æ‰“å¼€å¤±è´¥çš„æ¦‚ç‡ã€‚</div>
    <div class="rank-list" id="rank-container"></div>
    <div class="btn" id="btn-back">è¿”å›é¦–é¡µ</div>
  </div>

  <div id="fatal-box"></div>

  <script>
    (function () {
      'use strict';

      const levels = [
        { rows: 3, cols: 3, map: [[0,0,0],[0,0,0],[0,0,1]] },
        { rows: 4, cols: 4, map: [[0,0,0,0],[0,1,0,0],[0,0,0,0],[0,0,0,0]] },
        { rows: 4, cols: 5, map: [[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0]] },
        { rows: 5, cols: 5, map: [[0,0,0,1,0],[0,1,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]] },
        { rows: 5, cols: 6, map: [[0,0,0,0,0,0],[0,0,1,0,1,0],[0,0,0,0,0,0],[0,1,0,0,0,0],[0,0,0,0,0,0]] }
      ];

      const pages = {
        home: document.getElementById('home-page'),
        game: document.getElementById('game-page'),
        rank: document.getElementById('rank-page')
      };
      const modals = {
        win: document.getElementById('modal-win'),
        final: document.getElementById('modal-final'),
        name: document.getElementById('name-modal')
      };
      const gridEl = document.getElementById('grid');
      const timerEl = document.getElementById('timer');
      const remainingEl = document.getElementById('remaining');
      const levelInfoEl = document.getElementById('level-info');
      const playerNameInput = document.getElementById('player-name');
      const fatalBox = document.getElementById('fatal-box');
      const RANK_KEY = 'tangyuan_rank_local_v2';

      let currentLevel = 0;
      let totalTime = 0;
      let startTime = 0;
      let timerInterval = null;
      let playerName = '';
      let path = [];
      let isDrawing = false;
      let totalTangyuanCount = 0;
      let usingPointerEvents = !!window.PointerEvent;
      let moveListenerAttached = false;

      function showFatal(msg) {
        fatalBox.textContent = msg;
        fatalBox.style.display = 'block';
      }

      function showPage(name) {
        Object.keys(pages).forEach(key => pages[key].classList.remove('active'));
        if (pages[name]) pages[name].classList.add('active');
      }

      function hideModals() {
        Object.keys(modals).forEach(key => modals[key].style.display = 'none');
      }

      function showNameModal() {
        hideModals();
        modals.name.style.display = 'flex';
        setTimeout(() => playerNameInput.focus(), 50);
      }

      function countTangyuan(level) {
        let count = 0;
        for (let r = 0; r < level.rows; r++) {
          for (let c = 0; c < level.cols; c++) {
            if (level.map[r][c] === 0) count++;
          }
        }
        return count;
      }

      function clampCellSize(rows, cols) {
        const vw = Math.max(320, Math.min(window.innerWidth || 390, 480));
        const vh = Math.max(568, window.innerHeight || 800);
        const usableW = vw - 80;
        const usableH = vh - 260;
        const sizeByW = Math.floor((usableW - (cols - 1) * 12) / cols);
        const sizeByH = Math.floor((usableH - (rows - 1) * 12) / rows);
        return Math.max(36, Math.min(56, sizeByW, sizeByH));
      }

      function renderLevel() {
        const level = levels[currentLevel];
        const cellSize = clampCellSize(level.rows, level.cols);
        document.documentElement.style.setProperty('--cell-size', cellSize + 'px');
        gridEl.style.gridTemplateColumns = `repeat(${level.cols}, ${cellSize}px)`;
        gridEl.innerHTML = '';
        totalTangyuanCount = countTangyuan(level);
        remainingEl.textContent = totalTangyuanCount;
        levelInfoEl.textContent = `ç¬¬ ${currentLevel + 1}/${levels.length} å…³`;

        for (let r = 0; r < level.rows; r++) {
          for (let c = 0; c < level.cols; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell ' + (level.map[r][c] === 1 ? 'egg' : 'tangyuan');
            cell.dataset.r = String(r);
            cell.dataset.c = String(c);
            if (level.map[r][c] === 0) {
              const mouth = document.createElement('div');
              mouth.className = 'mouth';
              const blushL = document.createElement('div');
              blushL.className = 'blush left';
              const blushR = document.createElement('div');
              blushR.className = 'blush right';
              cell.appendChild(mouth);
              cell.appendChild(blushL);
              cell.appendChild(blushR);
            }
            bindCellStart(cell);
            gridEl.appendChild(cell);
          }
        }
      }

      function startTimer() {
        stopTimer();
        startTime = Date.now();
        timerEl.textContent = '0.00s';
        timerInterval = setInterval(() => {
          timerEl.textContent = ((Date.now() - startTime) / 1000).toFixed(2) + 's';
        }, 50);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function startGame() {
        currentLevel = 0;
        totalTime = 0;
        path = [];
        showPage('game');
        hideModals();
        renderLevel();
        startTimer();
      }

      function startNextLevel() {
        hideModals();
        path = [];
        renderLevel();
        startTimer();
      }

      function bindCellStart(cell) {
        if (usingPointerEvents) {
          cell.addEventListener('pointerdown', onInputStart, { passive: false });
        } else {
          cell.addEventListener('mousedown', onInputStart, { passive: false });
          cell.addEventListener('touchstart', onInputStart, { passive: false });
        }
      }

      function getPointFromEvent(e) {
        if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        if (e.changedTouches && e.changedTouches[0]) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
        return { x: e.clientX, y: e.clientY };
      }

      function attachMoveListeners() {
        if (moveListenerAttached) return;
        moveListenerAttached = true;
        if (usingPointerEvents) {
          document.addEventListener('pointermove', onInputMove, { passive: false });
          document.addEventListener('pointerup', onInputEnd, { passive: true });
          document.addEventListener('pointercancel', onInputEnd, { passive: true });
        } else {
          document.addEventListener('mousemove', onInputMove, { passive: false });
          document.addEventListener('mouseup', onInputEnd, { passive: true });
          document.addEventListener('touchmove', onInputMove, { passive: false });
          document.addEventListener('touchend', onInputEnd, { passive: true });
          document.addEventListener('touchcancel', onInputEnd, { passive: true });
        }
      }

      function detachMoveListeners() {
        if (!moveListenerAttached) return;
        moveListenerAttached = false;
        document.removeEventListener('pointermove', onInputMove);
        document.removeEventListener('pointerup', onInputEnd);
        document.removeEventListener('pointercancel', onInputEnd);
        document.removeEventListener('mousemove', onInputMove);
        document.removeEventListener('mouseup', onInputEnd);
        document.removeEventListener('touchmove', onInputMove);
        document.removeEventListener('touchend', onInputEnd);
        document.removeEventListener('touchcancel', onInputEnd);
      }

      function onInputStart(e) {
        e.preventDefault();
        const cell = e.currentTarget;
        if (!cell || cell.classList.contains('egg')) return;
        const r = parseInt(cell.dataset.r, 10);
        const c = parseInt(cell.dataset.c, 10);
        path = [{ r, c }];
        isDrawing = true;
        updateVisuals();
        attachMoveListeners();
      }

      function onInputMove(e) {
        if (!isDrawing) return;
        if (e.cancelable) e.preventDefault();
        const p = getPointFromEvent(e);
        const el = document.elementFromPoint(p.x, p.y);
        if (!el || !el.classList || !el.classList.contains('cell')) return;
        const r = parseInt(el.dataset.r, 10);
        const c = parseInt(el.dataset.c, 10);
        addToPath(r, c);
      }

      function onInputEnd() {
        if (!isDrawing) return;
        isDrawing = false;
        detachMoveListeners();
        checkWin();
      }

      function addToPath(r, c) {
        const last = path[path.length - 1];
        if (!last) {
          path = [{ r, c }];
          updateVisuals();
          return;
        }
        if (last.r === r && last.c === c) return;
        const dr = Math.abs(last.r - r);
        const dc = Math.abs(last.c - c);
        if (dr + dc !== 1) return;

        const existingIndex = path.findIndex(p => p.r === r && p.c === c);
        if (existingIndex !== -1) {
          path = path.slice(0, existingIndex + 1);
          updateVisuals();
          return;
        }

        if (levels[currentLevel].map[r][c] === 1) {
          path = [];
          updateVisuals();
          gridEl.style.transform = 'translateX(5px)';
          setTimeout(() => { gridEl.style.transform = 'translateX(0)'; }, 90);
          return;
        }

        path.push({ r, c });
        updateVisuals();
      }

      function updateVisuals() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(cell => cell.classList.remove('path', 'eaten'));
        path.forEach((p, index) => {
          const cell = document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`);
          if (!cell) return;
          if (index === path.length - 1) cell.classList.add('path');
          else cell.classList.add('eaten');
        });
        updateRemaining();
      }

      function updateRemaining() {
        const unique = new Set(path.map(p => `${p.r},${p.c}`));
        remainingEl.textContent = String(Math.max(0, totalTangyuanCount - unique.size));
      }

      function checkWin() {
        const unique = new Set(path.map(p => `${p.r},${p.c}`));
        if (unique.size !== totalTangyuanCount) return;
        stopTimer();
        const levelTime = (Date.now() - startTime) / 1000;
        totalTime += levelTime;
        if (currentLevel < levels.length - 1) {
          document.getElementById('win-msg').textContent = `æœ¬å…³ç”¨æ—¶ ${levelTime.toFixed(2)}s`;
          document.getElementById('btn-next').textContent = 'ä¸‹ä¸€å…³';
          modals.win.style.display = 'flex';
          document.getElementById('btn-next').onclick = function () {
            currentLevel += 1;
            startNextLevel();
          };
        } else {
          document.getElementById('final-time').textContent = totalTime.toFixed(2) + 's';
          modals.final.style.display = 'flex';
        }
      }

      function readRank() {
        try {
          const raw = localStorage.getItem(RANK_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed : [];
        } catch (_) {
          return [];
        }
      }

      function writeRank(list) {
        try {
          localStorage.setItem(RANK_KEY, JSON.stringify(list));
          return true;
        } catch (_) {
          return false;
        }
      }

      function saveScore() {
        const list = readRank();
        list.push({
          name: playerName,
          time: Number(totalTime.toFixed(2)),
          timestamp: Date.now()
        });
        list.sort((a, b) => a.time - b.time || a.timestamp - b.timestamp);
        const ok = writeRank(list.slice(0, 20));
        hideModals();
        showPage('rank');
        renderRank(ok ? 'æˆç»©å·²ä¿å­˜åˆ°æœ¬æœºæ’è¡Œæ¦œ' : 'æˆç»©å·²ç”Ÿæˆï¼Œä½†æµè§ˆå™¨æœªå…è®¸æœ¬åœ°å­˜å‚¨');
      }

      function renderRank(message) {
        const container = document.getElementById('rank-container');
        const list = readRank();
        container.innerHTML = '';
        if (message) {
          const msg = document.createElement('div');
          msg.className = 'rank-item';
          msg.style.justifyContent = 'center';
          msg.textContent = message;
          container.appendChild(msg);
        }
        if (!list.length) {
          const empty = document.createElement('div');
          empty.className = 'rank-item';
          empty.style.justifyContent = 'center';
          empty.textContent = 'è¿˜æ²¡æœ‰æˆç»©ï¼Œå¿«æ¥æŒ‘æˆ˜ç¬¬ä¸€åå§ï¼';
          container.appendChild(empty);
          return;
        }
        list.forEach((item, i) => {
          const date = new Date(item.timestamp || Date.now());
          const dateStr = `${date.getMonth() + 1}-${date.getDate()}`;
          const row = document.createElement('div');
          row.className = 'rank-item';
          row.innerHTML = `<span>${i + 1}. ${escapeHtml(item.name)} (${dateStr})</span><span>${Number(item.time).toFixed(2)}s</span>`;
          container.appendChild(row);
        });
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"]+/g, function (m) {
          return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[m] || m;
        });
      }

      function bindUI() {
        document.getElementById('btn-start').addEventListener('click', showNameModal);
        document.getElementById('btn-confirm-name').addEventListener('click', function () {
          const name = playerNameInput.value.trim();
          if (!name) {
            alert('è¯·è¾“å…¥æ‚¨çš„å§“åï¼');
            return;
          }
          playerName = name.slice(0, 10);
          hideModals();
          startGame();
        });
        playerNameInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') document.getElementById('btn-confirm-name').click();
        });
        document.getElementById('btn-rank').addEventListener('click', function () {
          showPage('rank');
          renderRank();
        });
        document.getElementById('btn-back').addEventListener('click', function () {
          showPage('home');
        });
        document.getElementById('btn-submit').addEventListener('click', saveScore);
        window.addEventListener('resize', function () {
          if (pages.game.classList.contains('active')) renderLevel();
        });
      }

      bindUI();
    })();

    window.addEventListener('error', function (e) {
      var msg = 'é¡µé¢å·²æ‰“å¼€ï¼Œä½†è„šæœ¬å‡ºç°å¼‚å¸¸ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯');
      var box = document.getElementById('fatal-box');
      if (box) {
        box.textContent = msg;
        box.style.display = 'block';
      }
    });
  </script>
</body>
</html>
