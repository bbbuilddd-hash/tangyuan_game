<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€ç¬”åƒæ±¤åœ† - å¯çˆ±å…¨æœç‰ˆ</title>
    

    <style>
        :root {
            --bg-color: #ffccbc; /* æš–ç²‰è‰²èƒŒæ™¯ */
            --primary-color: #ff7043;
            --text-color: #5d4037;
            --grid-gap: 12px;
            --cell-size: 50px; 
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #ffab91 0%, #ffccbc 70%);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        .page.active { display: flex; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ ‡é¢˜æ ·å¼ */
        .game-title {
            font-size: 2.2rem;
            color: #d84315;
            text-shadow: 2px 2px 0px #fff;
            margin-bottom: 10px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 2px;
        }

        .btn {
            background: #fff;
            border: 3px solid #ff7043;
            border-radius: 50px;
            padding: 12px 40px;
            font-size: 1.3rem;
            color: #d84315;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ffab91;
            transition: all 0.1s;
            width: 80%;
            max-width: 280px;
            text-align: center;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ffab91;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #d84315;
            background: rgba(255,255,255,0.6);
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* æ¸¸æˆæç¤ºæ–‡å­— */
        .game-tip {
            font-size: 1rem;
            color: #d84315;
            background: rgba(255,255,255,0.7);
            padding: 8px 20px;
            border-radius: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }

        .grid-container {
            display: grid;
            gap: var(--grid-gap);
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 20px;
            touch-action: none; /* ç¦æ­¢è§¦æ‘¸æ»šåŠ¨ */
            box-shadow: 0 10px 20px rgba(216, 67, 21, 0.15);
            position: relative;
            max-width: 90vw; /* é™åˆ¶ç½‘æ ¼æœ€å¤§å®½åº¦ */
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
            background: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- CSS ç»˜åˆ¶å¯çˆ±æ±¤åœ† --- */
        .cell.tangyuan::before {
            content: '';
            position: absolute;
            width: 85%;
            height: 85%;
            background: #fff;
            border-radius: 50%;
            z-index: 1;
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.05);
        }
        /* çœ¼ç› */
        .cell.tangyuan::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background: #333;
            border-radius: 50%;
            top: 38%;
            left: 35%;
            box-shadow: 12px 0 0 #333; /* å³çœ¼ */
            z-index: 2;
        }
        /* å˜´å·´ */
        .cell.tangyuan .mouth {
            position: absolute;
            width: 6px;
            height: 3px;
            border-bottom: 2px solid #ff5252;
            border-radius: 50%;
            top: 55%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        /* è…®çº¢ */
        .cell.tangyuan .blush {
            position: absolute;
            width: 8px;
            height: 5px;
            background: #ffab91;
            border-radius: 50%;
            top: 52%;
            opacity: 0.7;
            z-index: 1;
        }
        .cell.tangyuan .blush.left { left: 22%; }
        .cell.tangyuan .blush.right { right: 22%; }

        /* --- CSS ç»˜åˆ¶è·åŒ…è›‹ (éšœç¢) --- */
        .cell.egg {
            background: transparent;
            box-shadow: none;
            border: none;
        }
        .cell.egg::before {
            content: '';
            position: absolute;
            width: 90%;
            height: 90%;
            background: #fff;
            /* ä¸è§„åˆ™è›‹ç™½å½¢çŠ¶ */
            border-radius: 45% 55% 50% 50% / 55% 45% 50% 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
            transform: rotate(15deg);
        }
        .cell.egg::after {
            content: '';
            position: absolute;
            width: 40%;
            height: 40%;
            background: #ffca28;
            border-radius: 50%;
            top: 30%;
            left: 30%;
            z-index: 2;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1);
            transform: rotate(-15deg);
        }

        /* è·¯å¾„çŠ¶æ€ */
        .cell.path {
            background: #ffcc80; /* é€‰ä¸­å˜é»„ */
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 160, 0, 0.6);
        }
        .cell.eaten {
            background: #fff9c4; /* åƒè¿‡å˜æµ…é»„ */
            opacity: 0.6;
            transform: scale(0.9);
        }
        /* åƒè¿‡çš„æ±¤åœ†éšè—äº”å®˜ */
        .cell.eaten::after, 
        .cell.eaten .mouth, 
        .cell.eaten .blush {
            display: none;
        }
        .cell.eaten::before {
            background: #fff9c4;
        }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .modal.show { display: flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 { color: #d84315; font-size: 2rem; margin: 0 0 10px 0; }
        .modal p { font-size: 1.2rem; color: #5d4037; }
        
        .big-emoji { font-size: 5rem; margin: 20px 0; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* æ’è¡Œæ¦œè¡¨æ ¼ */
        .rank-list {
            width: 90%;
            max-width: 350px;
            background: #fff;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 60vh;
            overflow-y: auto;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px dashed #ffccbc;
            font-size: 1rem;
        }
        .rank-item:first-child { color: #ffca28; font-weight: bold; text-shadow: 0 0 2px #d84315; } 
        .rank-item:nth-child(2) { color: #9e9e9e; font-weight: bold; }
        .rank-item:nth-child(3) { color: #ff7043; font-weight: bold; }

        /* å§“åè¾“å…¥å¼¹çª—æ ·å¼ */
        #name-modal input {
            width: 80%;
            max-width: 280px;
            padding: 12px 20px;
            border: 3px solid #ff7043;
            border-radius: 50px;
            font-size: 1.2rem;
            color: #5d4037;
            margin: 20px 0;
            text-align: center;
            outline: none;
        }
        #name-modal input::placeholder {
            color: #ffab91;
        }

    </style>
</head>
<body>

    <div id="home-page" class="page active">
        <div class="big-emoji">ğŸ¡</div>
        <h1 class="game-title">ä¸€ç¬”åƒæ±¤åœ†</h1>
        <p style="color: #d84315; margin-bottom: 30px; font-size: 1.1rem;">é¿å¼€ç…è›‹ ğŸ³ï¼Œè¿å®Œæ‰€æœ‰æ±¤åœ†ï¼</p>
        
        <div class="btn" id="btn-start">å¼€å§‹æŒ‘æˆ˜</div>
        <div class="btn" id="btn-rank" style="background: #ffccbc; border-color: #d84315;">æ’è¡Œæ¦œ</div>
    </div>

    <div id="game-page" class="page">
        <div class="game-header">
            <span id="level-info">ç¬¬ 1/5 å…³</span>
            <span id="timer">0.00s</span>
        </div>
        
        <div class="game-tip">é¿å¼€ç…è›‹ï¼Œä¸€ç¬”è¿æ¥æ‰€æœ‰æ±¤åœ†</div>
        
        <div style="margin-bottom: 10px; font-size: 0.9rem; color: #d84315; background: rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 10px;">
            å‰©ä½™æ±¤åœ†ï¼š<span id="remaining" style="font-weight: bold; font-size: 1.1rem;">0</span>
        </div>

        <div id="grid" class="grid-container">
            </div>
    </div>

    <div id="modal-win" class="modal">
        <div class="big-emoji">ğŸ˜‹</div>
        <h2>å¤ªå¥½åƒå•¦ï¼</h2>
        <p id="win-msg">æœ¬å…³ç”¨æ—¶ 3.5s</p>
        <div class="btn" id="btn-next">ä¸‹ä¸€å…³</div>
    </div>

    <div id="modal-final" class="modal">
        <div class="big-emoji">ğŸ†</div>
        <h2>æŒ‘æˆ˜æˆåŠŸï¼</h2>
        <p>æ€»ç”¨æ—¶ï¼š<span id="final-time" style="color: #d84315; font-weight: bold; font-size: 1.5rem;">0s</span></p>
        <div class="btn" id="btn-submit">æäº¤æˆç»©</div>
    </div>

    <div id="name-modal" class="modal">
        <div class="big-emoji">âœï¸</div>
        <h2>è¯·è¾“å…¥æ‚¨çš„å§“å</h2>
        <input type="text" id="player-name" placeholder="æ¯”å¦‚ï¼šåƒè´§å°æ±¤åœ†" maxlength="10">
        <div class="btn" id="btn-confirm-name">ç¡®è®¤å¼€å§‹</div>
    </div>

    <div id="rank-page" class="page">
        <h2 class="game-title">ğŸ… åƒè´§æ’è¡Œæ¦œ</h2>
        <div class="rank-list" id="rank-container">
            </div>
        <div class="btn" id="btn-back">è¿”å›é¦–é¡µ</div>
    </div>

    
    <script>
        // ==========================================
        //  äº‘ç«¯ / æœ¬åœ° åŒä¿é™©é…ç½®
        //  è¯´æ˜ï¼š
        //  1) ä¸å†ä¾èµ– head é‡Œçš„ç¬¬ä¸‰æ–¹ CDN è„šæœ¬ï¼Œé™ä½ iPhone / Safari é¦–å±åŠ è½½å¤±è´¥æ¦‚ç‡
        //  2) äº‘ç«¯æ’è¡Œæ¦œèµ° Supabase REST API
        //  3) äº‘ç«¯å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æœ¬åœ°æ’è¡Œæ¦œï¼Œæ¸¸æˆæœ¬ä½“ä¸å—å½±å“
        // ==========================================
        const SUPABASE_URL = 'https://qnjhnzddnweuhzmyxyod.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuamhuemRkbndldWh6bXl4eW9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTQ5MjksImV4cCI6MjA4NzY3MDkyOX0.WYGj5lYF0Zt56izo51TzH6bRMB5Tp2yCVD3Jy2lV3bA';
        const LEADERBOARD_TABLE = 'leaderboard';
        const LOCAL_SCORE_KEY = 'tangyuan_local_leaderboard_v1';
        const FETCH_TIMEOUT_MS = 6000;

        const CLOUD_AVAILABLE =
            typeof SUPABASE_URL === 'string' &&
            typeof SUPABASE_KEY === 'string' &&
            /^https:\/\//.test(SUPABASE_URL) &&
            SUPABASE_KEY.length > 20;

        // --- å…³å¡é…ç½® (0: æ±¤åœ†ï¼Œ1: ç…è›‹éšœç¢) ---
        const levels = [
            { rows: 3, cols: 3, map: [ [0, 0, 0], [0, 0, 0], [0, 0, 1] ] },
            { rows: 4, cols: 4, map: [ [0, 0, 0, 0], [0, 1, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0] ] },
            { rows: 4, cols: 5, map: [ [0, 0, 1, 0, 0], [0, 0, 1, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0] ] },
            { rows: 5, cols: 5, map: [ [0, 0, 0, 1, 0], [0, 1, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0] ] },
            { rows: 5, cols: 6, map: [ [0, 0, 0, 0, 0, 0], [0, 0, 1, 0, 1, 0], [0, 0, 0, 0, 0, 0], [0, 1, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0] ] }
        ];

        let currentLevel = 0;
        let totalTime = 0;
        let startTime = 0;
        let timerInterval = null;
        let playerName = '';
        let path = [];
        let isDrawing = false;
        let totalTangyuanCount = 0;
        let rankMode = 'cloud';
        let activePointerId = null;

        // DOM
        const pages = {
            home: document.getElementById('home-page'),
            game: document.getElementById('game-page'),
            rank: document.getElementById('rank-page')
        };
        const modals = {
            win: document.getElementById('modal-win'),
            final: document.getElementById('modal-final'),
            name: document.getElementById('name-modal')
        };
        const gridEl = document.getElementById('grid');
        const timerEl = document.getElementById('timer');
        const remainingEl = document.getElementById('remaining');
        const levelInfoEl = document.getElementById('level-info');
        const playerNameInput = document.getElementById('player-name');

        function createRequestOptions(method, body) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

            return {
                timeoutId,
                options: {
                    method,
                    signal: controller.signal,
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: body ? JSON.stringify(body) : undefined
                }
            };
        }

        async function restInsertScore(name, time) {
            if (!CLOUD_AVAILABLE) {
                throw new Error('äº‘ç«¯æœªé…ç½®');
            }

            const { timeoutId, options } = createRequestOptions('POST', [
                { name, time: Number(time.toFixed(2)) }
            ]);

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}`, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Prefer': 'return=minimal'
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP ${response.status}`);
                }
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function restFetchScores(limit = 10) {
            if (!CLOUD_AVAILABLE) {
                throw new Error('äº‘ç«¯æœªé…ç½®');
            }

            const { timeoutId, options } = createRequestOptions('GET');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/${LEADERBOARD_TABLE}?select=*&order=time.asc&limit=${limit}`,
                    options
                );

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP ${response.status}`);
                }

                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } finally {
                clearTimeout(timeoutId);
            }
        }

        function getLocalScores() {
            try {
                const raw = localStorage.getItem(LOCAL_SCORE_KEY);
                const data = raw ? JSON.parse(raw) : [];
                return Array.isArray(data) ? data : [];
            } catch (e) {
                return [];
            }
        }

        function saveLocalScore(name, time) {
            const scores = getLocalScores();
            scores.push({
                name,
                time: Number(time.toFixed(2)),
                created_at: new Date().toISOString(),
                source: 'local'
            });

            scores.sort((a, b) => a.time - b.time);
            localStorage.setItem(LOCAL_SCORE_KEY, JSON.stringify(scores.slice(0, 20)));
        }

        function formatDateText(value) {
            const date = value ? new Date(value) : new Date();
            if (Number.isNaN(date.getTime())) return '';
            return `${date.getMonth() + 1}-${date.getDate()}`;
        }

        function renderRankList(items, mode = 'cloud') {
            const container = document.getElementById('rank-container');
            container.innerHTML = '';

            if (!items.length) {
                const empty = document.createElement('div');
                empty.className = 'rank-item';
                empty.style.justifyContent = 'center';
                empty.textContent = mode === 'local' ? 'æœ¬åœ°æš‚æ— æˆç»©è®°å½•' : 'æš‚æ— æˆç»©è®°å½•';
                container.appendChild(empty);
                return;
            }

            items.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'rank-item';
                const dateStr = formatDateText(item.created_at);
                const sourceTag = mode === 'local' ? 'æœ¬åœ°' : dateStr;
                div.innerHTML = `
                    <span>${i + 1}. ${escapeHtml(item.name || 'åŒ¿åç©å®¶')} (${sourceTag})</span>
                    <span>${Number(item.time || 0).toFixed(2)}s</span>
                `;
                container.appendChild(div);
            });
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, ch => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[ch]));
        }

        // --- å¯¼èˆª ---
        function showPage(name) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[name].classList.add('active');
        }

        function showModal(name) {
            modals[name].classList.add('show');
        }

        function hideModals() {
            Object.values(modals).forEach(m => m.classList.remove('show'));
        }

        // --- æ¸¸æˆæ ¸å¿ƒ ---
        function showNameModal() {
            playerNameInput.value = '';
            showModal('name');
        }

        function startGame() {
            currentLevel = 0;
            totalTime = 0;
            loadLevel(0);
        }

        function loadLevel(idx) {
            currentLevel = idx;
            const config = levels[idx];

            // é‡ç½®
            path = [];
            isDrawing = false;
            activePointerId = null;
            totalTangyuanCount = 0;

            // UI
            levelInfoEl.textContent = `ç¬¬ ${idx + 1}/${levels.length} å…³`;
            hideModals();
            showPage('game');

            // æ¸²æŸ“ç½‘æ ¼
            renderGrid(config);
            startTimer();
        }

        function updateCellSize(config) {
            const vw = Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
            const vh = Math.min(window.innerHeight, document.documentElement.clientHeight || window.innerHeight);
            const horizontalPadding = 70;
            const verticalReserve = 280;
            const gap = 12;

            const maxCellByWidth = Math.floor((vw - horizontalPadding - gap * (config.cols - 1)) / config.cols);
            const maxCellByHeight = Math.floor((vh - verticalReserve - gap * (config.rows - 1)) / config.rows);
            const safeCell = Math.max(36, Math.min(56, maxCellByWidth, maxCellByHeight));

            document.documentElement.style.setProperty('--cell-size', `${safeCell}px`);
        }

        function renderGrid(config) {
            updateCellSize(config);
            gridEl.innerHTML = '';
            gridEl.style.gridTemplateColumns = `repeat(${config.cols}, var(--cell-size))`;

            for (let r = 0; r < config.rows; r++) {
                for (let c = 0; c < config.cols; c++) {
                    const type = config.map[r][c];
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;

                    if (type === 0) {
                        cell.classList.add('tangyuan');

                        const mouth = document.createElement('div');
                        mouth.className = 'mouth';
                        const blushL = document.createElement('div');
                        blushL.className = 'blush left';
                        const blushR = document.createElement('div');
                        blushR.className = 'blush right';
                        cell.appendChild(mouth);
                        cell.appendChild(blushL);
                        cell.appendChild(blushR);

                        totalTangyuanCount++;
                    } else {
                        cell.classList.add('egg');
                    }

                    gridEl.appendChild(cell);
                }
            }

            updateRemaining();
        }

        function getCellFromPoint(x, y) {
            const el = document.elementFromPoint(x, y);
            return el && el.closest ? el.closest('.cell') : null;
        }

        function startDrawFromCell(cell) {
            if (!cell) return;

            const r = parseInt(cell.dataset.r, 10);
            const c = parseInt(cell.dataset.c, 10);
            if (levels[currentLevel].map[r][c] !== 0) return;

            isDrawing = true;
            path = [{ r, c }];
            updateVisuals();
        }

        // --- è¾“å…¥å¤„ç†ï¼šä¼˜å…ˆ Pointer Eventsï¼Œè€ç¯å¢ƒå›é€€ Touch / Mouse ---
        function onPointerDown(e) {
            if (e.pointerType === 'mouse' && e.button !== 0) return;
            const target = e.target.closest('.cell');
            if (!target || isDrawing) return;

            e.preventDefault();
            activePointerId = e.pointerId;
            startDrawFromCell(target);

            try {
                if (gridEl.setPointerCapture && activePointerId !== null) {
                    gridEl.setPointerCapture(activePointerId);
                }
            } catch (err) {}
        }

        function onPointerMove(e) {
            if (!isDrawing || e.pointerId !== activePointerId) return;

            e.preventDefault();
            const cell = getCellFromPoint(e.clientX, e.clientY);
            if (!cell) return;
            addToPath(parseInt(cell.dataset.r, 10), parseInt(cell.dataset.c, 10));
        }

        function onPointerUp(e) {
            if (activePointerId !== null && e.pointerId !== activePointerId) return;
            finishDrawing();
        }

        function onTouchStart(e) {
            if (isDrawing) return;
            const touch = e.changedTouches[0];
            const target = e.target.closest('.cell');
            if (!touch || !target) return;

            e.preventDefault();
            startDrawFromCell(target);
        }

        function onTouchMove(e) {
            if (!isDrawing) return;
            const touch = e.touches[0];
            if (!touch) return;

            e.preventDefault();
            const cell = getCellFromPoint(touch.clientX, touch.clientY);
            if (!cell) return;
            addToPath(parseInt(cell.dataset.r, 10), parseInt(cell.dataset.c, 10));
        }

        function onMouseDown(e) {
            if (e.button !== 0 || isDrawing) return;
            const target = e.target.closest('.cell');
            if (!target) return;

            e.preventDefault();
            startDrawFromCell(target);
        }

        function onMouseMove(e) {
            if (!isDrawing) return;
            const cell = getCellFromPoint(e.clientX, e.clientY);
            if (!cell) return;
            addToPath(parseInt(cell.dataset.r, 10), parseInt(cell.dataset.c, 10));
        }

        function finishDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            activePointerId = null;
            checkWin();
        }

        function addToPath(r, c) {
            if (!path.length) return;

            const last = path[path.length - 1];
            if (last.r === r && last.c === c) return;

            const dr = Math.abs(last.r - r);
            const dc = Math.abs(last.c - c);
            if (dr + dc !== 1) return;

            const existingIndex = path.findIndex(p => p.r === r && p.c === c);
            if (existingIndex !== -1) {
                path = path.slice(0, existingIndex + 1);
                updateVisuals();
                return;
            }

            if (levels[currentLevel].map[r][c] === 1) {
                path = [];
                updateVisuals();
                gridEl.style.transform = "translateX(5px)";
                setTimeout(() => {
                    gridEl.style.transform = "translateX(0)";
                }, 100);
                return;
            }

            path.push({ r, c });
            updateVisuals();
        }

        function updateVisuals() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('path', 'eaten');
            });

            path.forEach((p, index) => {
                const cell = document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`);
                if (cell) {
                    if (index === path.length - 1) {
                        cell.classList.add('path');
                    } else {
                        cell.classList.add('eaten');
                    }
                }
            });

            updateRemaining();
        }

        function updateRemaining() {
            const unique = new Set(path.map(p => `${p.r},${p.c}`));
            const eaten = unique.size;
            remainingEl.textContent = Math.max(0, totalTangyuanCount - eaten);
        }

        function checkWin() {
            const unique = new Set(path.map(p => `${p.r},${p.c}`));
            if (unique.size === totalTangyuanCount) {
                stopTimer();
                const levelTime = (Date.now() - startTime) / 1000;
                totalTime += levelTime;

                if (currentLevel < levels.length - 1) {
                    document.getElementById('win-msg').textContent = `æœ¬å…³ç”¨æ—¶ ${levelTime.toFixed(2)}s`;
                    document.getElementById('btn-next').textContent = "ä¸‹ä¸€å…³";
                    document.getElementById('btn-next').onclick = () => loadLevel(currentLevel + 1);
                    showModal('win');
                } else {
                    document.getElementById('final-time').textContent = totalTime.toFixed(2) + 's';
                    showModal('final');
                }
            } else {
                path = [];
                updateVisuals();
            }
        }

        // --- è®¡æ—¶å™¨ ---
        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);

            timerEl.textContent = '0.00s';
            timerInterval = setInterval(() => {
                const t = (Date.now() - startTime) / 1000;
                timerEl.textContent = t.toFixed(2) + 's';
            }, 50);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // ==========================================
        //  æ’è¡Œæ¦œé€»è¾‘ï¼šäº‘ç«¯ä¼˜å…ˆï¼Œå¤±è´¥è‡ªåŠ¨å›é€€æœ¬åœ°
        // ==========================================
        async function submitScore() {
            if (!playerName) playerName = 'åŒ¿åç©å®¶';

            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.textContent = "æäº¤ä¸­...";
            btnSubmit.style.pointerEvents = "none";

            let cloudOk = false;

            try {
                await restInsertScore(playerName, totalTime);
                cloudOk = true;
                rankMode = 'cloud';
            } catch (err) {
                console.warn('äº‘ç«¯æäº¤å¤±è´¥ï¼Œå·²å›é€€åˆ°æœ¬åœ°æ’è¡Œï¼š', err);
                saveLocalScore(playerName, totalTime);
                rankMode = 'local';
            } finally {
                btnSubmit.textContent = "æäº¤æˆç»©";
                btnSubmit.style.pointerEvents = "auto";
            }

            await renderRank();

            if (!cloudOk) {
                alert('å½“å‰ç½‘ç»œä¸ç¨³å®šï¼Œæˆç»©å·²å…ˆä¿å­˜åˆ°æœ¬æœºæ’è¡Œæ¦œã€‚');
            }

            hideModals();
            showPage('rank');
        }

        async function renderRank() {
            const container = document.getElementById('rank-container');
            container.innerHTML = '<div class="rank-item" style="justify-content: center;">åŠ è½½æ’è¡Œæ¦œä¸­...</div>';

            try {
                const data = await restFetchScores(10);
                rankMode = 'cloud';
                renderRankList(data, 'cloud');
            } catch (err) {
                console.warn('äº‘ç«¯æ¦œå•æ‹‰å–å¤±è´¥ï¼Œæ˜¾ç¤ºæœ¬åœ°æ¦œå•ï¼š', err);
                rankMode = 'local';
                renderRankList(getLocalScores().slice(0, 10), 'local');
            }
        }

        function bindInputEvents() {
            if (window.PointerEvent) {
                gridEl.addEventListener('pointerdown', onPointerDown, { passive: false });
                gridEl.addEventListener('pointermove', onPointerMove, { passive: false });
                window.addEventListener('pointerup', onPointerUp);
                window.addEventListener('pointercancel', finishDrawing);
            } else {
                gridEl.addEventListener('touchstart', onTouchStart, { passive: false });
                window.addEventListener('touchmove', onTouchMove, { passive: false });
                window.addEventListener('touchend', finishDrawing);
                window.addEventListener('touchcancel', finishDrawing);

                gridEl.addEventListener('mousedown', onMouseDown);
                window.addEventListener('mousemove', onMouseMove);
                window.addEventListener('mouseup', finishDrawing);
            }
        }

        // --- äº‹ä»¶ç»‘å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            bindInputEvents();

            document.getElementById('btn-start').addEventListener('click', showNameModal);

            document.getElementById('btn-confirm-name').addEventListener('click', () => {
                const name = playerNameInput.value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥æ‚¨çš„å§“åï¼');
                    return;
                }

                playerName = name;
                hideModals();
                startGame();
            });

            document.getElementById('btn-rank').addEventListener('click', async () => {
                showPage('rank');
                await renderRank();
            });

            document.getElementById('btn-submit').addEventListener('click', submitScore);
            document.getElementById('btn-back').addEventListener('click', () => {
                hideModals();
                showPage('home');
            });

            window.addEventListener('resize', () => {
                if (pages.game.classList.contains('active')) {
                    renderGrid(levels[currentLevel]);
                    updateVisuals();
                }
            });
        });
    </script>

</body>
</html>
