<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€ç¬”åƒæ±¤åœ† - å¯çˆ±å…¨æœç‰ˆ</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-color: #ffccbc; /* æš–ç²‰è‰²èƒŒæ™¯ */
            --primary-color: #ff7043;
            --text-color: #5d4037;
            --grid-gap: 12px;
            --cell-size: 50px; 
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #ffab91 0%, #ffccbc 70%);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        .page.active { display: flex; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ ‡é¢˜æ ·å¼ */
        .game-title {
            font-size: 2.2rem;
            color: #d84315;
            text-shadow: 2px 2px 0px #fff;
            margin-bottom: 10px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 2px;
        }

        .btn {
            background: #fff;
            border: 3px solid #ff7043;
            border-radius: 50px;
            padding: 12px 40px;
            font-size: 1.3rem;
            color: #d84315;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ffab91;
            transition: all 0.1s;
            width: 80%;
            max-width: 280px;
            text-align: center;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ffab91;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #d84315;
            background: rgba(255,255,255,0.6);
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* æ¸¸æˆæç¤ºæ–‡å­— */
        .game-tip {
            font-size: 1rem;
            color: #d84315;
            background: rgba(255,255,255,0.7);
            padding: 8px 20px;
            border-radius: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }

        .grid-container {
            display: grid;
            gap: var(--grid-gap);
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 20px;
            touch-action: none; /* ç¦æ­¢è§¦æ‘¸æ»šåŠ¨ */
            box-shadow: 0 10px 20px rgba(216, 67, 21, 0.15);
            position: relative;
            max-width: 90vw; /* é™åˆ¶ç½‘æ ¼æœ€å¤§å®½åº¦ */
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
            background: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- CSS ç»˜åˆ¶å¯çˆ±æ±¤åœ† --- */
        .cell.tangyuan::before {
            content: '';
            position: absolute;
            width: 85%;
            height: 85%;
            background: #fff;
            border-radius: 50%;
            z-index: 1;
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.05);
        }
        /* çœ¼ç› */
        .cell.tangyuan::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background: #333;
            border-radius: 50%;
            top: 38%;
            left: 35%;
            box-shadow: 12px 0 0 #333; /* å³çœ¼ */
            z-index: 2;
        }
        /* å˜´å·´ */
        .cell.tangyuan .mouth {
            position: absolute;
            width: 6px;
            height: 3px;
            border-bottom: 2px solid #ff5252;
            border-radius: 50%;
            top: 55%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        /* è…®çº¢ */
        .cell.tangyuan .blush {
            position: absolute;
            width: 8px;
            height: 5px;
            background: #ffab91;
            border-radius: 50%;
            top: 52%;
            opacity: 0.7;
            z-index: 1;
        }
        .cell.tangyuan .blush.left { left: 22%; }
        .cell.tangyuan .blush.right { right: 22%; }

        /* --- CSS ç»˜åˆ¶è·åŒ…è›‹ (éšœç¢) --- */
        .cell.egg {
            background: transparent;
            box-shadow: none;
            border: none;
        }
        .cell.egg::before {
            content: '';
            position: absolute;
            width: 90%;
            height: 90%;
            background: #fff;
            /* ä¸è§„åˆ™è›‹ç™½å½¢çŠ¶ */
            border-radius: 45% 55% 50% 50% / 55% 45% 50% 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
            transform: rotate(15deg);
        }
        .cell.egg::after {
            content: '';
            position: absolute;
            width: 40%;
            height: 40%;
            background: #ffca28;
            border-radius: 50%;
            top: 30%;
            left: 30%;
            z-index: 2;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.1);
            transform: rotate(-15deg);
        }

        /* è·¯å¾„çŠ¶æ€ */
        .cell.path {
            background: #ffcc80; /* é€‰ä¸­å˜é»„ */
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 160, 0, 0.6);
        }
        .cell.eaten {
            background: #fff9c4; /* åƒè¿‡å˜æµ…é»„ */
            opacity: 0.6;
            transform: scale(0.9);
        }
        /* åƒè¿‡çš„æ±¤åœ†éšè—äº”å®˜ */
        .cell.eaten::after, 
        .cell.eaten .mouth, 
        .cell.eaten .blush {
            display: none;
        }
        .cell.eaten::before {
            background: #fff9c4;
        }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .modal.show { display: flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 { color: #d84315; font-size: 2rem; margin: 0 0 10px 0; }
        .modal p { font-size: 1.2rem; color: #5d4037; }
        
        .big-emoji { font-size: 5rem; margin: 20px 0; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* æ’è¡Œæ¦œè¡¨æ ¼ */
        .rank-list {
            width: 90%;
            max-width: 350px;
            background: #fff;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 60vh;
            overflow-y: auto;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px dashed #ffccbc;
            font-size: 1rem;
        }
        .rank-item:first-child { color: #ffca28; font-weight: bold; text-shadow: 0 0 2px #d84315; } 
        .rank-item:nth-child(2) { color: #9e9e9e; font-weight: bold; }
        .rank-item:nth-child(3) { color: #ff7043; font-weight: bold; }

        /* å§“åè¾“å…¥å¼¹çª—æ ·å¼ */
        #name-modal input {
            width: 80%;
            max-width: 280px;
            padding: 12px 20px;
            border: 3px solid #ff7043;
            border-radius: 50px;
            font-size: 1.2rem;
            color: #5d4037;
            margin: 20px 0;
            text-align: center;
            outline: none;
        }
        #name-modal input::placeholder {
            color: #ffab91;
        }

    </style>
</head>
<body>

    <div id="home-page" class="page active">
        <div class="big-emoji">ğŸ¡</div>
        <h1 class="game-title">ä¸€ç¬”åƒæ±¤åœ†</h1>
        <p style="color: #d84315; margin-bottom: 30px; font-size: 1.1rem;">é¿å¼€ç…è›‹ ğŸ³ï¼Œè¿å®Œæ‰€æœ‰æ±¤åœ†ï¼</p>
        
        <div class="btn" id="btn-start">å¼€å§‹æŒ‘æˆ˜</div>
        <div class="btn" id="btn-rank" style="background: #ffccbc; border-color: #d84315;">æ’è¡Œæ¦œ</div>
    </div>

    <div id="game-page" class="page">
        <div class="game-header">
            <span id="level-info">ç¬¬ 1/5 å…³</span>
            <span id="timer">0.00s</span>
        </div>
        
        <div class="game-tip">é¿å¼€ç…è›‹ï¼Œä¸€ç¬”è¿æ¥æ‰€æœ‰æ±¤åœ†</div>
        
        <div style="margin-bottom: 10px; font-size: 0.9rem; color: #d84315; background: rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 10px;">
            å‰©ä½™æ±¤åœ†ï¼š<span id="remaining" style="font-weight: bold; font-size: 1.1rem;">0</span>
        </div>

        <div id="grid" class="grid-container">
            </div>
    </div>

    <div id="modal-win" class="modal">
        <div class="big-emoji">ğŸ˜‹</div>
        <h2>å¤ªå¥½åƒå•¦ï¼</h2>
        <p id="win-msg">æœ¬å…³ç”¨æ—¶ 3.5s</p>
        <div class="btn" id="btn-next">ä¸‹ä¸€å…³</div>
    </div>

    <div id="modal-final" class="modal">
        <div class="big-emoji">ğŸ†</div>
        <h2>æŒ‘æˆ˜æˆåŠŸï¼</h2>
        <p>æ€»ç”¨æ—¶ï¼š<span id="final-time" style="color: #d84315; font-weight: bold; font-size: 1.5rem;">0s</span></p>
        <div class="btn" id="btn-submit">æäº¤æˆç»©</div>
    </div>

    <div id="name-modal" class="modal">
        <div class="big-emoji">âœï¸</div>
        <h2>è¯·è¾“å…¥æ‚¨çš„å§“å</h2>
        <input type="text" id="player-name" placeholder="æ¯”å¦‚ï¼šåƒè´§å°æ±¤åœ†" maxlength="10">
        <div class="btn" id="btn-confirm-name">ç¡®è®¤å¼€å§‹</div>
    </div>

    <div id="rank-page" class="page">
        <h2 class="game-title">ğŸ… åƒè´§æ’è¡Œæ¦œ</h2>
        <div class="rank-list" id="rank-container">
            </div>
        <div class="btn" id="btn-back">è¿”å›é¦–é¡µ</div>
    </div>

    <script>
        // ==========================================
        //  é…ç½®æ‚¨çš„ Supabase äº‘ç«¯æ•°æ®åº“
        // ==========================================
        const SUPABASE_URL = 'https://qnjhnzddnweuhzmyxyod.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuamhuemRkbndldWh6bXl4eW9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTQ5MjksImV4cCI6MjA4NzY3MDkyOX0.WYGj5lYF0Zt56izo51TzH6bRMB5Tp2yCVD3Jy2lV3bA';
        
        let supabaseClient = null;
        try {
            // é˜²å´©æºƒä¿æŠ¤ï¼šå¦‚æœè¿˜æ²¡å¡«å¯¹ URLï¼Œæ¸¸æˆè¿˜èƒ½ç…§å¸¸æœ¬åœ°ç©
            if (SUPABASE_URL.startsWith('http')) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                console.warn("æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„ Supabase é…ç½®ï¼Œç°åœ¨æ˜¯å•æœºæ¨¡å¼ï¼");
            }
        } catch (e) {
            console.error("æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥", e);
        }

        // --- å…³å¡é…ç½® (0: æ±¤åœ†ï¼Œ1: ç…è›‹éšœç¢) ---
        const levels = [
            { rows: 3, cols: 3, map: [ [0, 0, 0], [0, 0, 0], [0, 0, 1] ] },
            { rows: 4, cols: 4, map: [ [0, 0, 0, 0], [0, 1, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0] ] },
            { rows: 4, cols: 5, map: [ [0, 0, 1, 0, 0], [0, 0, 1, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0] ] },
            { rows: 5, cols: 5, map: [ [0, 0, 0, 1, 0], [0, 1, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0], [0, 0, 0, 0, 0] ] },
            { rows: 5, cols: 6, map: [ [0, 0, 0, 0, 0, 0], [0, 0, 1, 0, 1, 0], [0, 0, 0, 0, 0, 0], [0, 1, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0] ] }
        ];

        let currentLevel = 0;
        let totalTime = 0;
        let startTime = 0;
        let timerInterval = null;
        let playerName = '';
        let path = [];
        let isDrawing = false;
        let totalTangyuanCount = 0;

        // DOM
        const pages = {
            home: document.getElementById('home-page'),
            game: document.getElementById('game-page'),
            rank: document.getElementById('rank-page')
        };
        const modals = {
            win: document.getElementById('modal-win'),
            final: document.getElementById('modal-final'),
            name: document.getElementById('name-modal')
        };
        const gridEl = document.getElementById('grid');
        const timerEl = document.getElementById('timer');
        const remainingEl = document.getElementById('remaining');
        const levelInfoEl = document.getElementById('level-info');
        const playerNameInput = document.getElementById('player-name');

        // --- å¯¼èˆª ---
        function showPage(name) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[name].classList.add('active');
        }

        function showModal(name) {
            modals[name].classList.add('show');
        }

        function hideModals() {
            Object.values(modals).forEach(m => m.classList.remove('show'));
        }

        // --- æ¸¸æˆæ ¸å¿ƒ ---
        function showNameModal() {
            playerNameInput.value = '';
            showModal('name');
        }

        function startGame() {
            currentLevel = 0;
            totalTime = 0;
            loadLevel(0);
        }

        function loadLevel(idx) {
            currentLevel = idx;
            const config = levels[idx];
            
            // é‡ç½®
            path = [];
            isDrawing = false;
            totalTangyuanCount = 0;
            
            // UI
            levelInfoEl.textContent = `ç¬¬ ${idx + 1}/${levels.length} å…³`;
            hideModals();
            showPage('game');
            
            // æ¸²æŸ“ç½‘æ ¼
            renderGrid(config);
            startTimer();
        }

        function renderGrid(config) {
            gridEl.innerHTML = '';
            gridEl.style.gridTemplateColumns = `repeat(${config.cols}, var(--cell-size))`;
            
            for(let r=0; r<config.rows; r++) {
                for(let c=0; c<config.cols; c++) {
                    const type = config.map[r][c];
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    if (type === 0) {
                        cell.classList.add('tangyuan');
                        const mouth = document.createElement('div');
                        mouth.className = 'mouth';
                        const blushL = document.createElement('div');
                        blushL.className = 'blush left';
                        const blushR = document.createElement('div');
                        blushR.className = 'blush right';
                        cell.appendChild(mouth);
                        cell.appendChild(blushL);
                        cell.appendChild(blushR);
                        
                        totalTangyuanCount++;
                        cell.addEventListener('mousedown', onInputStart);
                        cell.addEventListener('touchstart', onInputStart, {passive: false});
                    } else {
                        cell.classList.add('egg');
                    }
                    gridEl.appendChild(cell);
                }
            }
            updateRemaining();
        }

        // --- è¾“å…¥å¤„ç† ---
        function onInputStart(e) {
            if (e.type === 'touchstart') e.preventDefault();
            if (isDrawing) return;

            const target = e.target.closest('.cell');
            if (!target) return;

            const r = parseInt(target.dataset.r);
            const c = parseInt(target.dataset.c);
            if (levels[currentLevel].map[r][c] !== 0) return;
            isDrawing = true;
            path = [{r, c}];
            updateVisuals();

            document.addEventListener('mousemove', onInputMove);
            document.addEventListener('touchmove', onInputMove, {passive: false});
            document.addEventListener('mouseup', onInputEnd);
            document.addEventListener('touchend', onInputEnd);
        }

        function onInputMove(e) {
            if (!isDrawing) return;
            if (e.type === 'touchmove') e.preventDefault();

            let x, y;
            if (e.type === 'touchmove') {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }

            const el = document.elementFromPoint(x - window.scrollX, y - window.scrollY);
            if (!el || !el.classList.contains('cell')) return;

            const r = parseInt(el.dataset.r);
            const c = parseInt(el.dataset.c);

            addToPath(r, c);
        }

        function onInputEnd() {
            if (!isDrawing) return;
            isDrawing = false;
            
            try {
                document.removeEventListener('mousemove', onInputMove);
                document.removeEventListener('touchmove', onInputMove);
                document.removeEventListener('mouseup', onInputEnd);
                document.removeEventListener('touchend', onInputEnd);
            } catch (e) {}

            checkWin();
        }

        function addToPath(r, c) {
            const last = path[path.length - 1];
            if (last.r === r && last.c === c) return;

            const dr = Math.abs(last.r - r);
            const dc = Math.abs(last.c - c);
            if (dr + dc !== 1) return;
            
            const existingIndex = path.findIndex(p => p.r === r && p.c === c);
            if (existingIndex !== -1) {
                path = path.slice(0, existingIndex + 1);
                updateVisuals();
                return;
            }

            if (levels[currentLevel].map[r][c] === 1) {
                path = [];
                updateVisuals();
                gridEl.style.transform = "translateX(5px)";
                setTimeout(() => gridEl.style.transform = "translateX(0)", 100);
                return;
            }

            path.push({r, c});
            updateVisuals();
        }

        function updateVisuals() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('path', 'eaten');
            });
            path.forEach((p, index) => {
                const cell = document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`);
                if (cell) {
                    if (index === path.length - 1) {
                        cell.classList.add('path'); 
                    } else {
                        cell.classList.add('eaten'); 
                    }
                }
             });
            updateRemaining();
        }

        function updateRemaining() {
            const unique = new Set(path.map(p => `${p.r},${p.c}`));
            const eaten = unique.size;
            remainingEl.textContent = Math.max(0, totalTangyuanCount - eaten);
        }

        function checkWin() {
            const unique = new Set(path.map(p => `${p.r},${p.c}`));
            if (unique.size === totalTangyuanCount) {
                stopTimer();
                const levelTime = (Date.now() - startTime) / 1000;
                totalTime += levelTime;
                if (currentLevel < levels.length - 1) {
                    document.getElementById('win-msg').textContent = `æœ¬å…³ç”¨æ—¶ ${levelTime.toFixed(2)}s`;
                    document.getElementById('btn-next').textContent = "ä¸‹ä¸€å…³";
                    document.getElementById('btn-next').onclick = () => loadLevel(currentLevel + 1);
                    showModal('win');
                } else {
                    document.getElementById('final-time').textContent = totalTime.toFixed(2) + 's';
                    showModal('final');
                }
            } else {
                path = [];
                updateVisuals();
            }
        }

        // --- è®¡æ—¶å™¨ ---
        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const t = (Date.now() - startTime) / 1000;
                timerEl.textContent = t.toFixed(2) + 's';
            }, 50);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // ==========================================
        //  äº‘ç«¯æ’è¡Œæ¦œæ ¸å¿ƒé€»è¾‘ä¿®æ”¹
        // ==========================================
        async function submitScore() {
            if (!playerName) playerName = 'åŒ¿åç©å®¶';
            
            const btnSubmit = document.getElementById('btn-submit');
            
            // æ²¡è¿æ•°æ®åº“ï¼Œæç¤ºä¸€ä¸‹ï¼Œç„¶ååªåœ¨æœ¬åœ°æ¨¡æ‹Ÿå±•ç¤º
            if (!supabaseClient) {
                alert("å½“å‰æœªè¿æ¥æ•°æ®åº“ï¼ˆæ‚¨è¿˜æ²¡é…ç½®URLå’ŒKeyï¼‰ï¼Œæˆç»©å°†ä¸ä¼šè¢«å…¨æœè®°å½•å“¦~");
                hideModals();
                showPage('rank');
                return;
            }

            btnSubmit.textContent = "ä¸Šä¼ æˆç»©ä¸­...";
            btnSubmit.style.pointerEvents = "none";

            try {
                const { error } = await supabaseClient
                    .from('leaderboard')
                    .insert([{ name: playerName, time: parseFloat(totalTime.toFixed(2)) }]);
                
                if (error) {
                    alert("äº‘ç«¯è®°å½•å¤±è´¥ï¼š" + error.message);
                } else {
                    // æäº¤æˆåŠŸåæ‹‰å–æœ€æ–°æ¦œå•
                    await renderRank();
                    hideModals();
                    showPage('rank');
                }
            } catch (err) {
                alert("ç½‘ç»œé—®é¢˜æˆ–é…ç½®é”™è¯¯ï¼Œæäº¤å¤±è´¥ï¼");
            } finally {
                btnSubmit.textContent = "æäº¤æˆç»©";
                btnSubmit.style.pointerEvents = "auto";
            }
        }

        async function renderRank() {
            const container = document.getElementById('rank-container');
            
            if (!supabaseClient) {
                container.innerHTML = '<div class="rank-item" style="justify-content: center;">æœªè¿æ¥æ•°æ®åº“ï¼Œæ— æ³•åŠ è½½</div>';
                return;
            }

            container.innerHTML = '<div class="rank-item" style="justify-content: center;">æ‹‰å–å…¨æœæ•°æ®ä¸­...</div>';
            
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .order('time', { ascending: true })
                    .limit(10);
                
                container.innerHTML = '';
                
                if (error || !data || data.length === 0) {
                    container.innerHTML = '<div class="rank-item" style="justify-content: center;">æš‚æ— æˆç»©è®°å½•</div>';
                    return;
                }

                data.forEach((item, i) => {
                    // è§£ææ—¶é—´ï¼ˆå¦‚æœè¡¨ä¸­æ²¡æœ‰ created_atï¼Œé»˜è®¤æ˜¾ç¤ºä»Šå¤©æ—¥æœŸï¼‰
                    let dateStr = "";
                    if (item.created_at) {
                        const date = new Date(item.created_at);
                        dateStr = `${date.getMonth()+1}-${date.getDate()}`;
                    } else {
                        const now = new Date();
                        dateStr = `${now.getMonth()+1}-${now.getDate()}`;
                    }

                    const div = document.createElement('div');
                    div.className = 'rank-item';
                    div.innerHTML = `
                        <span>${i+1}. ${item.name} (${dateStr})</span>
                        <span>${item.time.toFixed(2)}s</span>
                    `;
                    container.appendChild(div);
                });
            } catch (err) {
                container.innerHTML = '<div class="rank-item" style="justify-content: center;">æ•°æ®æ‹‰å–å¤±è´¥</div>';
            }
        }

        // --- äº‹ä»¶ç»‘å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-start').addEventListener('click', showNameModal);
            
            document.getElementById('btn-confirm-name').addEventListener('click', () => {
                const name = playerNameInput.value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥æ‚¨çš„å§“åï¼');
                    return;
                }
                playerName = name;
                hideModals();
                startGame();
            });

            // ç‚¹å‡»æ’è¡Œæ¦œæ—¶ï¼Œå¼‚æ­¥æ‹‰å–æ•°æ®
            document.getElementById('btn-rank').addEventListener('click', async () => {
                showPage('rank');
                await renderRank();
            });
            
            document.getElementById('btn-submit').addEventListener('click', submitScore);
            document.getElementById('btn-back').addEventListener('click', () => showPage('home'));
        });

    </script>
</body>
</html>
